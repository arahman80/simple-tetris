#include "game.h"

/* */
struct kick
{
  schar x, y;
};

static const struct kick srs_jsltz[4][4][5] = {
    {{{0, 0}, {0, 0}, {0, 0}, {0, 0}, {0, 0}},      // 0->0 (unused)
     {{0, 0}, {-1, 0}, {-1, 1}, {0, -2}, {-1, -2}}, // 0->1
     {{0, 0}, {0, 0}, {0, 0}, {0, 0}, {0, 0}},      // 0->2 (unused)
     {{0, 0}, {1, 0}, {1, 1}, {0, -2}, {1, -2}}},   // 0->3

    {{{0, 0}, {1, 0}, {1, -1}, {0, 2}, {1, 2}}, // 1->0
     {{0, 0}, {0, 0}, {0, 0}, {0, 0}, {0, 0}},  // 1->1 (unused)
     {{0, 0}, {1, 0}, {1, -1}, {0, 2}, {1, 2}}, // 1->2
     {{0, 0}, {0, 0}, {0, 0}, {0, 0}, {0, 0}}}, // 1->3 (unused)

    {{{0, 0}, {0, 0}, {0, 0}, {0, 0}, {0, 0}},      // 2->0 (unused)
     {{0, 0}, {-1, 0}, {-1, 1}, {0, -2}, {-1, -2}}, // 2->1
     {{0, 0}, {0, 0}, {0, 0}, {0, 0}, {0, 0}},      // 2->2 (unused)
     {{0, 0}, {1, 0}, {1, 1}, {0, -2}, {1, -2}}},   // 2->3

    {{{0, 0}, {-1, 0}, {-1, -1}, {0, 2}, {-1, 2}}, // 3->0
     {{0, 0}, {0, 0}, {0, 0}, {0, 0}, {0, 0}},     // 3->1 (unused)
     {{0, 0}, {-1, 0}, {-1, -1}, {0, 2}, {-1, 2}}, // 3->2
     {{0, 0}, {0, 0}, {0, 0}, {0, 0}, {0, 0}}}     // 3->3 (unused)
};

static const struct kick srs_i[4][4][5] = {
    {{{0, 0}, {0, 0}, {0, 0}, {0, 0}, {0, 0}},     // 0->0 (unused)
     {{0, 0}, {-2, 0}, {1, 0}, {-2, -1}, {1, 2}},  // 0->1
     {{0, 0}, {0, 0}, {0, 0}, {0, 0}, {0, 0}},     // 0->2 (unused)
     {{0, 0}, {-1, 0}, {2, 0}, {-1, 2}, {2, -1}}}, // 0->3

    {{{0, 0}, {2, 0}, {-1, 0}, {2, 1}, {-1, -2}}, // 1->0
     {{0, 0}, {0, 0}, {0, 0}, {0, 0}, {0, 0}},    // 1->1 (unused)
     {{0, 0}, {-1, 0}, {2, 0}, {-1, 2}, {2, -1}}, // 1->2
     {{0, 0}, {0, 0}, {0, 0}, {0, 0}, {0, 0}}},   // 1->3 (unused)

    {{{0, 0}, {0, 0}, {0, 0}, {0, 0}, {0, 0}},     // 2->0 (unused)
     {{0, 0}, {1, 0}, {-2, 0}, {1, -2}, {-2, 1}},  // 2->1
     {{0, 0}, {0, 0}, {0, 0}, {0, 0}, {0, 0}},     // 2->2 (unused)
     {{0, 0}, {2, 0}, {-1, 0}, {2, 1}, {-1, -2}}}, // 2->3

    {{{0, 0}, {1, 0}, {-2, 0}, {1, -2}, {-2, 1}}, // 3->0
     {{0, 0}, {0, 0}, {0, 0}, {0, 0}, {0, 0}},    // 3->1 (unused)
     {{0, 0}, {-2, 0}, {1, 0}, {-2, -1}, {1, 2}}, // 3->2
     {{0, 0}, {0, 0}, {0, 0}, {0, 0}, {0, 0}}}    // 3->3 (unused)
};

void
rotate_srs (struct tetris_piece* piece, uint board[21], schar clockwise)
{
  schar from = piece->selected_rotation, to;
  if (clockwise)
    to = (from + 1) % 4;
  else
    to = (from + 3) % 4;

  if (piece->piece_type == 'I')
  {
    for (int i = 0; i < 5; i++)
      if (is_valid (piece, board, srs_i[from][to][i].x, srs_i[from][to][i].y, 1,
                    clockwise))
      {
        piece->x += srs_i[from][to][i].x;
        piece->y += srs_i[from][to][i].y;
        piece->selected_rotation = to;
        break;
      }
  }
  else
  {
    for (int i = 0; i < 5; i++)
      if (is_valid (piece, board, srs_jsltz[from][to][i].x,
                    srs_jsltz[from][to][i].y, 1, clockwise))
      {
        piece->x += srs_jsltz[from][to][i].x;
        piece->y += srs_jsltz[from][to][i].y;
        piece->selected_rotation = to;
        break;
      }
  }
}